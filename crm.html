<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CardGift CRM v4.0</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¯</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--gold:#FFD700;--gold-dark:#B8860B;--bg-dark:#0f1419;--bg-card:#1a1f2e;--bg-lighter:#242b3d;--text:#E8E8E8;--text-muted:#9CA3AF;--accent:#00d4ff;--green:#4CAF50;--red:#f44336;--orange:#ff9800;--purple:#9c27b0;--border:rgba(255,215,0,0.2)}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:linear-gradient(135deg,var(--bg-dark),#1a1a2e,var(--bg-dark));color:var(--text);min-height:100vh}
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg-dark)}::-webkit-scrollbar-thumb{background:var(--gold-dark);border-radius:3px}
    
    .btn{padding:10px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{transform:translateY(-1px);opacity:.9}.btn:active{transform:scale(.98)}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#000}
    .btn-secondary{background:var(--bg-lighter);border:1px solid var(--border);color:var(--text)}
    .btn-success{background:rgba(76,175,80,.2);border:1px solid var(--green);color:var(--green)}
    .btn-danger{background:rgba(244,67,54,.2);border:1px solid var(--red);color:var(--red)}
    .btn-sm{padding:6px 12px;font-size:12px}
    
    .input{width:100%;padding:12px 14px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
    .input:focus{outline:none;border-color:var(--gold)}
    textarea.input{min-height:100px;resize:vertical}
    select.input{cursor:pointer}
    
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px}
    .tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500}
    .tag-blue{background:rgba(0,212,255,.2);color:var(--accent)}
    .tag-orange{background:rgba(255,152,0,.2);color:var(--orange)}
    .tag-purple{background:rgba(156,39,176,.2);color:var(--purple)}
    .tag-gold{background:rgba(255,215,0,.2);color:var(--gold)}
    .tag-green{background:rgba(76,175,80,.2);color:var(--green)}
    .tag-red{background:rgba(244,67,54,.2);color:var(--red)}
    
    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:linear-gradient(180deg,var(--bg-card),var(--bg-dark));border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:50}
    .sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
    .sidebar-nav{flex:1;padding:15px 10px;overflow-y:auto}
    .nav-section{font-size:10px;text-transform:uppercase;color:var(--text-muted);padding:15px 15px 8px;letter-spacing:1px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:10px;cursor:pointer;color:var(--text-muted);font-size:14px;transition:all .2s;margin-bottom:4px}
    .nav-item:hover{background:rgba(255,215,0,.1);color:var(--text)}
    .nav-item.active{background:rgba(255,215,0,.15);color:var(--gold)}
    .nav-item .icon{font-size:18px;width:24px;text-align:center}
    .nav-item .badge{margin-left:auto;background:var(--gold);color:#000;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}
    
    .main{margin-left:260px;flex:1;min-height:100vh}
    .header{background:rgba(26,31,46,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:15px 25px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:40}
    .content{padding:25px}
    
    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
    .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px}
    .stat-card .icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:10px}
    .stat-card .value{font-size:26px;font-weight:700;color:var(--gold)}
    .stat-card .label{font-size:12px;color:var(--text-muted);margin-top:4px}
    
    /* Funnel */
    .funnel-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:15px}
    .funnel-stage{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;min-height:400px}
    .funnel-header{padding:15px;border-bottom:1px solid var(--border);text-align:center}
    .funnel-header .icon{font-size:24px;margin-bottom:5px}
    .funnel-header .name{font-size:13px;font-weight:600}
    .funnel-header .count{font-size:11px;color:var(--text-muted);margin-top:3px}
    .funnel-body{padding:10px;max-height:350px;overflow-y:auto}
    .funnel-card{background:var(--bg-lighter);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px;cursor:pointer;transition:all .2s}
    .funnel-card:hover{border-color:var(--gold);transform:translateY(-2px)}
    .funnel-card .name{font-weight:500;margin-bottom:4px;font-size:13px}
    .funnel-card .contact{font-size:11px;color:var(--gold)}
    .funnel-card .meta{font-size:10px;color:var(--text-muted);margin-top:6px}
    
    /* Tasks */
    .task-item{display:flex;align-items:center;gap:12px;padding:15px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;margin-bottom:10px}
    .task-item.completed{opacity:.6}
    .task-checkbox{width:22px;height:22px;border-radius:6px;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .task-checkbox.checked{background:var(--green);border-color:var(--green)}
    .task-checkbox.checked::after{content:'âœ“';color:#fff;font-size:12px}
    .task-content{flex:1}
    .task-title{font-size:14px;margin-bottom:4px}
    .task-meta{font-size:11px;color:var(--text-muted)}
    
    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:600px;max-height:90vh;overflow:auto}
    .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:20px}
    .modal-footer{padding:15px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    
    /* Messages */
    .message-card{background:var(--bg-lighter);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all .2s}
    .message-card:hover{border-color:var(--gold)}
    .message-card .title{font-weight:500;color:var(--gold);margin-bottom:8px;font-size:13px}
    .message-card .content{font-size:12px;color:var(--text-muted);line-height:1.5;white-space:pre-wrap}
    
    /* Contacts list */
    .contact-row{display:flex;align-items:center;gap:15px;padding:15px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;cursor:pointer;transition:all .2s}
    .contact-row:hover{border-color:var(--gold)}
    .contact-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-dark));display:flex;align-items:center;justify-content:center;font-weight:600;color:#000;font-size:16px}
    .contact-info{flex:1}
    .contact-info .name{font-weight:500;margin-bottom:3px}
    .contact-info .detail{font-size:12px;color:var(--text-muted)}
    .contact-actions{display:flex;gap:8px}
    
    /* Loading */
    .loading{text-align:center;padding:60px}
    .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Connect screen */
    .connect-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .connect-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:40px;text-align:center;max-width:450px;width:100%}
    
    /* Responsive */
    @media(max-width:1200px){.funnel-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){
      .sidebar{display:none}
      .main{margin-left:0}
      .funnel-grid{grid-template-columns:repeat(2,1fr)}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>

<div id="app"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
  SUPABASE_URL: 'https://imgpysvdosdsqucoghqa.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZ3B5c3Zkb3Nkc3F1Y29naHFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTU0ODYsImV4cCI6MjA4MjEzMTQ4Nn0.HTRDARe0DkeyI4et9I5xcElToiHzrfJTr2kFpwoik0Y'
};

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ Supabase
if (typeof window.supabase === 'undefined') {
  console.error('Supabase library not loaded!');
}

const supabaseClient = window.supabase ? window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY) : null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRM APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CRMApp = {
  // State
  userId: null,
  template: null,
  stages: [],
  autoTasks: [],
  messages: [],
  contacts: [],
  tasks: [],
  stats: {},
  activeSection: 'dashboard',
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async init() {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ Supabase
    if (!supabaseClient) {
      this.showError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Supabase');
      return;
    }
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ userId Ğ¸Ğ· localStorage (Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¿Ñ€Ğ¸ Ğ²Ñ…Ğ¾Ğ´Ğµ Ğ² dashboard)
    this.userId = localStorage.getItem('cardgift_gw_id') 
                || localStorage.getItem('cardgift_display_id')
                || localStorage.getItem('userGwId');
    
    if (!this.userId) {
      this.showConnectScreen();
      return;
    }
    
    // Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ GW Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ
    this.userId = this.userId.toString().replace(/^GW/i, '');
    
    console.log('ğŸš€ CRM Init for user:', this.userId);
    
    this.showLoading();
    
    try {
      // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
      await this.loadTemplate();
      
      // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
      await this.loadContacts();
      await this.loadTasks();
      
      // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
      this.calculateStats();
      
      // Ğ ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ¼
      this.render();
      
    } catch (e) {
      console.error('CRM Init error:', e);
      this.showError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ CRM');
    }
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LOAD DATA
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async loadTemplate() {
    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½
    const { data: template } = await supabaseClient
      .from('crm_templates')
      .select('*')
      .eq('template_type', 'system')
      .eq('is_active', true)
      .limit(1)
      .maybeSingle();
    
    this.template = template;
    
    if (template) {
      // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ¿Ñ‹
      const { data: stages } = await supabaseClient
        .from('crm_stages')
        .select('*')
        .eq('template_id', template.id)
        .order('sort_order');
      
      this.stages = stages || [];
      
      // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
      const { data: autoTasks } = await supabaseClient
        .from('crm_auto_tasks')
        .select('*')
        .eq('template_id', template.id)
        .order('sort_order');
      
      this.autoTasks = autoTasks || [];
      
      // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
      const { data: messages } = await supabaseClient
        .from('crm_messages')
        .select('*')
        .eq('template_id', template.id)
        .order('sort_order');
      
      this.messages = messages || [];
    }
    
    console.log('ğŸ“Š Loaded:', this.stages.length, 'stages,', this.autoTasks.length, 'tasks,', this.messages.length, 'messages');
  },
  
  async loadContacts() {
    const gwId = 'GW' + this.userId;
    
    const { data } = await supabaseClient
      .from('crm_contacts')
      .select('*')
      .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
      .eq('status', 'active')
      .order('updated_at', { ascending: false });
    
    this.contacts = data || [];
    console.log('ğŸ‘¥ Loaded', this.contacts.length, 'contacts');
  },
  
  async loadTasks() {
    const gwId = 'GW' + this.userId;
    
    const { data } = await supabaseClient
      .from('crm_tasks')
      .select('*, contact:crm_contact_id(name, contact)')
      .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
      .eq('status', 'pending')
      .order('due_date');
    
    this.tasks = data || [];
    console.log('ğŸ“‹ Loaded', this.tasks.length, 'tasks');
  },
  
  calculateStats() {
    const byStage = {};
    this.stages.forEach(s => { byStage[s.code] = []; });
    
    this.contacts.forEach(c => {
      if (byStage[c.stage_code]) {
        byStage[c.stage_code].push(c);
      }
    });
    
    const today = new Date().toISOString().split('T')[0];
    const todayTasks = this.tasks.filter(t => t.due_date === today);
    const overdueTasks = this.tasks.filter(t => t.due_date && t.due_date < today);
    const converted = this.contacts.filter(c => c.is_converted).length;
    
    this.stats = {
      totalContacts: this.contacts.length,
      converted,
      conversionRate: this.contacts.length > 0 ? (converted / this.contacts.length * 100).toFixed(1) : 0,
      pendingTasks: this.tasks.length,
      todayTasks: todayTasks.length,
      overdueTasks: overdueTasks.length,
      byStage
    };
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SYNC FROM CONTACTS TABLE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async syncFromContacts() {
    const gwId = 'GW' + this.userId;
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ· Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ contacts
    const { data: sourceContacts } = await supabaseClient
      .from('contacts')
      .select('*')
      .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
      .neq('status', 'archived');
    
    if (!sourceContacts || sourceContacts.length === 0) {
      alert('ĞĞµÑ‚ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ°');
      return;
    }
    
    let imported = 0;
    let skipped = 0;
    
    for (const sc of sourceContacts) {
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚
      const { data: existing } = await supabaseClient
        .from('crm_contacts')
        .select('id')
        .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
        .eq('contact', sc.contact)
        .maybeSingle();
      
      if (existing) {
        skipped++;
        continue;
      }
      
      // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² CRM
      await supabaseClient.from('crm_contacts').insert({
        contact_id: sc.id,
        owner_gw_id: this.userId,
        name: sc.name,
        contact: sc.contact,
        messenger: sc.messenger,
        stage_code: 'new',
        stage_entered_at: new Date().toISOString(),
        source: sc.source || 'contacts_sync',
        status: 'active',
        temperature: 'warm',
        stage_history: JSON.stringify([{
          stage: 'new',
          entered_at: new Date().toISOString(),
          action: 'imported'
        }])
      });
      
      imported++;
    }
    
    alert(`Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: ${imported}\nĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ (Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹): ${skipped}`);
    
    // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼
    await this.loadContacts();
    this.calculateStats();
    this.render();
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTACT ACTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async addContact(data) {
    const contact = {
      owner_gw_id: this.userId,
      name: data.name,
      contact: data.contact,
      messenger: data.messenger,
      stage_code: 'new',
      stage_entered_at: new Date().toISOString(),
      source: 'manual',
      status: 'active',
      temperature: data.temperature || 'warm',
      notes: data.notes || '',
      stage_history: JSON.stringify([{
        stage: 'new',
        entered_at: new Date().toISOString(),
        action: 'created'
      }])
    };
    
    const { data: newContact, error } = await supabaseClient
      .from('crm_contacts')
      .insert(contact)
      .select()
      .single();
    
    if (error) {
      alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message);
      return;
    }
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ¿Ğ° "new"
    await this.createAutoTasksForContact(newContact.id, 'new');
    
    this.contacts.unshift(newContact);
    this.calculateStats();
    this.closeModal();
    this.render();
  },
  
  async moveContactToStage(contactId, newStage) {
    const contact = this.contacts.find(c => c.id === contactId);
    if (!contact) return;
    
    const oldStage = contact.stage_code;
    
    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ
    let history = [];
    try { history = JSON.parse(contact.stage_history || '[]'); } catch(e) {}
    history.push({
      stage: newStage,
      from: oldStage,
      entered_at: new Date().toISOString()
    });
    
    await supabaseClient
      .from('crm_contacts')
      .update({
        stage_code: newStage,
        stage_entered_at: new Date().toISOString(),
        stage_history: JSON.stringify(history),
        updated_at: new Date().toISOString()
      })
      .eq('id', contactId);
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ°
    await this.createAutoTasksForContact(contactId, newStage);
    
    // Ğ•ÑĞ»Ğ¸ "active" - Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°ĞµĞ¼ ĞºĞ°Ğº ĞºĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
    if (newStage === 'active') {
      await supabaseClient
        .from('crm_contacts')
        .update({
          is_converted: true,
          converted_at: new Date().toISOString(),
          status: 'converted'
        })
        .eq('id', contactId);
    }
    
    // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼
    await this.loadContacts();
    await this.loadTasks();
    this.calculateStats();
    this.render();
  },
  
  async createAutoTasksForContact(contactId, stageCode) {
    const stage = this.stages.find(s => s.code === stageCode);
    if (!stage) return;
    
    const stageTasks = this.autoTasks.filter(t => t.stage_id === stage.id && t.trigger_type === 'on_enter');
    
    for (const at of stageTasks) {
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + (at.due_days || 1));
      
      await supabaseClient.from('crm_tasks').insert({
        owner_gw_id: this.userId,
        crm_contact_id: contactId,
        title: at.title,
        description: at.description,
        icon: at.icon,
        task_type: 'auto',
        auto_task_id: at.id,
        due_date: dueDate.toISOString().split('T')[0],
        priority: at.priority,
        status: 'pending'
      });
    }
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // TASK ACTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  async addTask(data) {
    const task = {
      owner_gw_id: this.userId,
      crm_contact_id: data.contact_id || null,
      title: data.title,
      description: data.description || '',
      icon: 'ğŸ“‹',
      task_type: 'manual',
      due_date: data.due_date,
      priority: data.priority || 'normal',
      status: 'pending'
    };
    
    const { data: newTask, error } = await supabaseClient
      .from('crm_tasks')
      .insert(task)
      .select()
      .single();
    
    if (!error) {
      this.tasks.push(newTask);
      this.closeModal();
      this.render();
    }
  },
  
  async completeTask(taskId) {
    await supabaseClient
      .from('crm_tasks')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString()
      })
      .eq('id', taskId);
    
    this.tasks = this.tasks.filter(t => t.id !== taskId);
    this.calculateStats();
    this.render();
  },
  
  async deleteTask(taskId) {
    if (!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ?')) return;
    
    await supabaseClient.from('crm_tasks').delete().eq('id', taskId);
    this.tasks = this.tasks.filter(t => t.id !== taskId);
    this.render();
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  render() {
    const app = document.getElementById('app');
    
    app.innerHTML = `
      <div class="app">
        ${this.renderSidebar()}
        <main class="main">
          ${this.renderHeader()}
          <div class="content">
            ${this.renderContent()}
          </div>
        </main>
      </div>
    `;
    
    this.bindEvents();
  },
  
  renderSidebar() {
    const navItems = [
      { id: 'dashboard', icon: 'ğŸ“ˆ', text: 'Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´' },
      { id: 'funnel', icon: 'ğŸ¯', text: 'Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞºĞ°', badge: this.contacts.length },
      { id: 'contacts', icon: 'ğŸ‘¥', text: 'ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹' },
      { id: 'tasks', icon: 'âœ…', text: 'Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸', badge: this.tasks.length },
      { id: 'messages', icon: 'ğŸ’¬', text: 'Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹' },
      { id: 'settings', icon: 'âš™ï¸', text: 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸' }
    ];
    
    return `
      <aside class="sidebar">
        <div class="sidebar-header">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:28px;">ğŸ¯</span>
            <div>
              <div style="font-size:18px;font-weight:700;color:var(--gold);">CardGift CRM</div>
              <div style="font-size:10px;color:var(--text-muted);">v4.0</div>
            </div>
          </div>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-section">Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</div>
          ${navItems.map(item => `
            <div class="nav-item ${this.activeSection === item.id ? 'active' : ''}" data-section="${item.id}">
              <span class="icon">${item.icon}</span>
              <span>${item.text}</span>
              ${item.badge ? `<span class="badge">${item.badge}</span>` : ''}
            </div>
          `).join('')}
        </nav>
        <div style="padding:15px;border-top:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">ID: ${this.userId}</div>
          <a href="dashboard.html" class="btn btn-secondary btn-sm" style="width:100%;text-decoration:none;justify-content:center;">â† ĞŸĞ°Ğ½ĞµĞ»ÑŒ</a>
        </div>
      </aside>
    `;
  },
  
  renderHeader() {
    const titles = {
      dashboard: 'ğŸ“ˆ Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´',
      funnel: 'ğŸ¯ Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞºĞ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶',
      contacts: 'ğŸ‘¥ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹',
      tasks: 'âœ… Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸',
      messages: 'ğŸ’¬ Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹',
      settings: 'âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸'
    };
    
    return `
      <header class="header">
        <h1 style="font-size:20px;">${titles[this.activeSection] || ''}</h1>
        <div style="display:flex;gap:10px;">
          ${this.activeSection === 'contacts' || this.activeSection === 'funnel' ? `
            <button class="btn btn-secondary" onclick="CRMApp.syncFromContacts()">ğŸ”„ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚</button>
            <button class="btn btn-primary" onclick="CRMApp.showAddContactModal()">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
          ` : ''}
          ${this.activeSection === 'tasks' ? `
            <button class="btn btn-primary" onclick="CRMApp.showAddTaskModal()">â• Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°</button>
          ` : ''}
        </div>
      </header>
    `;
  },
  
  renderContent() {
    switch (this.activeSection) {
      case 'dashboard': return this.renderDashboard();
      case 'funnel': return this.renderFunnel();
      case 'contacts': return this.renderContacts();
      case 'tasks': return this.renderTasks();
      case 'messages': return this.renderMessages();
      case 'settings': return this.renderSettings();
      default: return '';
    }
  },
  
  renderDashboard() {
    return `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="icon" style="background:rgba(0,212,255,.2);">ğŸ‘¥</div>
          <div class="value">${this.stats.totalContacts}</div>
          <div class="label">Ğ’ÑĞµĞ³Ğ¾ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background:rgba(76,175,80,.2);">ğŸš€</div>
          <div class="value">${this.stats.converted}</div>
          <div class="label">ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background:rgba(255,215,0,.2);">ğŸ“Š</div>
          <div class="value">${this.stats.conversionRate}%</div>
          <div class="label">ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background:rgba(255,152,0,.2);">âœ…</div>
          <div class="value">${this.stats.pendingTasks}</div>
          <div class="label">Ğ—Ğ°Ğ´Ğ°Ñ‡</div>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="card">
          <h3 style="margin-bottom:15px;">ğŸ¯ Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞºĞ°</h3>
          ${this.stages.map(stage => {
            const count = this.stats.byStage[stage.code]?.length || 0;
            const percent = this.stats.totalContacts > 0 ? (count / this.stats.totalContacts * 100).toFixed(0) : 0;
            return `
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                <span style="font-size:18px;">${stage.icon}</span>
                <span style="flex:1;font-size:13px;">${stage.name.replace(/^[^\s]+\s/, '')}</span>
                <span class="tag tag-gold">${count}</span>
                <span style="font-size:11px;color:var(--text-muted);width:40px;">${percent}%</span>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="card">
          <h3 style="margin-bottom:15px;">ğŸ“‹ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</h3>
          ${this.stats.todayTasks === 0 ? `
            <div style="text-align:center;padding:20px;color:var(--text-muted);">
              <div style="font-size:30px;margin-bottom:10px;">ğŸ‰</div>
              ĞĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
            </div>
          ` : this.tasks.filter(t => t.due_date === new Date().toISOString().split('T')[0]).slice(0, 5).map(t => `
            <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
              <span class="tag tag-${t.priority === 'urgent' ? 'red' : t.priority === 'high' ? 'orange' : 'blue'}" style="width:8px;height:8px;padding:0;border-radius:50%;"></span>
              <span style="flex:1;font-size:13px;">${t.title}</span>
              ${t.contact ? `<span style="font-size:11px;color:var(--text-muted);">${t.contact.name}</span>` : ''}
            </div>
          `).join('')}
          ${this.stats.overdueTasks > 0 ? `
            <div style="margin-top:15px;padding:10px;background:rgba(244,67,54,.1);border-radius:8px;font-size:12px;color:var(--red);">
              âš ï¸ ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ¾: ${this.stats.overdueTasks} Ğ·Ğ°Ğ´Ğ°Ñ‡
            </div>
          ` : ''}
        </div>
      </div>
      
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-bottom:15px;">ğŸš€ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="CRMApp.showAddContactModal()">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚</button>
          <button class="btn btn-secondary" onclick="CRMApp.showAddTaskModal()">ğŸ“‹ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ</button>
          <button class="btn btn-secondary" onclick="CRMApp.syncFromContacts()">ğŸ”„ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ¸Ğ· Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²</button>
          <button class="btn btn-secondary" onclick="CRMApp.setSection('funnel')">ğŸ¯ Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞºĞ°</button>
        </div>
      </div>
    `;
  },
  
  renderFunnel() {
    return `
      <div class="funnel-grid">
        ${this.stages.map(stage => {
          const contacts = this.stats.byStage[stage.code] || [];
          return `
            <div class="funnel-stage">
              <div class="funnel-header" style="border-left:3px solid var(--${stage.color || 'gold'});">
                <div class="icon">${stage.icon}</div>
                <div class="name">${stage.name.replace(/^[^\s]+\s/, '')}</div>
                <div class="count">${contacts.length} ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²</div>
              </div>
              <div class="funnel-body">
                ${contacts.length === 0 ? `
                  <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;">
                    ĞŸÑƒÑÑ‚Ğ¾
                  </div>
                ` : contacts.map(c => `
                  <div class="funnel-card" onclick="CRMApp.showContactDetail('${c.id}')">
                    <div class="name">${c.name || 'Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸'}</div>
                    <div class="contact">${c.contact}</div>
                    <div class="meta">${c.messenger || ''} â€¢ ${this.formatDate(c.stage_entered_at)}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  },
  
  renderContacts() {
    return `
      <div style="margin-bottom:20px;">
        <input type="text" class="input" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñƒ..." id="search-input" style="max-width:400px;">
      </div>
      
      ${this.contacts.length === 0 ? `
        <div class="card" style="text-align:center;padding:40px;">
          <div style="font-size:50px;margin-bottom:15px;">ğŸ‘¥</div>
          <h3 style="margin-bottom:10px;">ĞĞµÑ‚ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²</h3>
          <p style="color:var(--text-muted);margin-bottom:20px;">Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ»Ğ¸ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¸Ğ· Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²</p>
          <button class="btn btn-primary" onclick="CRMApp.syncFromContacts()">ğŸ”„ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ¸Ğ· Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²</button>
        </div>
      ` : this.contacts.map(c => {
        const stage = this.stages.find(s => s.code === c.stage_code);
        return `
          <div class="contact-row" onclick="CRMApp.showContactDetail('${c.id}')">
            <div class="contact-avatar">${(c.name || '?')[0].toUpperCase()}</div>
            <div class="contact-info">
              <div class="name">${c.name || 'Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸'}</div>
              <div class="detail">${c.contact} â€¢ ${c.messenger || 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½'}</div>
            </div>
            <span class="tag tag-${stage?.color || 'blue'}">${stage?.icon || ''} ${stage?.name?.replace(/^[^\s]+\s/, '') || c.stage_code}</span>
          </div>
        `;
      }).join('')}
    `;
  },
  
  renderTasks() {
    const today = new Date().toISOString().split('T')[0];
    
    return `
      ${this.tasks.length === 0 ? `
        <div class="card" style="text-align:center;padding:40px;">
          <div style="font-size:50px;margin-bottom:15px;">âœ…</div>
          <h3 style="margin-bottom:10px;">ĞĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡</h3>
          <p style="color:var(--text-muted);margin-bottom:20px;">Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ°Ğ¼Ğ¸</p>
          <button class="btn btn-primary" onclick="CRMApp.showAddTaskModal()">â• Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ</button>
        </div>
      ` : this.tasks.map(t => {
        const isOverdue = t.due_date && t.due_date < today;
        return `
          <div class="task-item ${t.status === 'completed' ? 'completed' : ''}">
            <div class="task-checkbox ${t.status === 'completed' ? 'checked' : ''}" onclick="CRMApp.completeTask('${t.id}')"></div>
            <div class="task-content">
              <div class="task-title">${t.icon || 'ğŸ“‹'} ${t.title}</div>
              <div class="task-meta">
                ${t.contact ? `ğŸ‘¤ ${t.contact.name} â€¢ ` : ''}
                ğŸ“… ${this.formatDate(t.due_date)}
                ${isOverdue ? ' <span style="color:var(--red);">âš ï¸ ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ¾</span>' : ''}
              </div>
            </div>
            <span class="tag tag-${t.priority === 'urgent' ? 'red' : t.priority === 'high' ? 'orange' : 'blue'}">${t.priority}</span>
            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();CRMApp.deleteTask('${t.id}')">ğŸ—‘ï¸</button>
          </div>
        `;
      }).join('')}
    `;
  },
  
  renderMessages() {
    return `
      <p style="color:var(--text-muted);margin-bottom:20px;">
        Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğµ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ° Ğ²Ğ¾Ñ€Ğ¾Ğ½ĞºĞ¸. ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ.
      </p>
      
      ${this.stages.map(stage => {
        const stageMessages = this.messages.filter(m => m.stage_id === stage.id);
        if (stageMessages.length === 0) return '';
        
        return `
          <div class="card" style="margin-bottom:20px;">
            <h3 style="margin-bottom:15px;">${stage.icon} ${stage.name}</h3>
            ${stageMessages.map(m => `
              <div class="message-card" onclick="CRMApp.copyMessage(\`${m.content.replace(/`/g, "'")}\`)">
                <div class="title">${m.title}</div>
                <div class="content">${m.content.substring(0, 200)}${m.content.length > 200 ? '...' : ''}</div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('')}
    `;
  },
  
  renderSettings() {
    return `
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin-bottom:15px;">ğŸ¯ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ CRM</h3>
        <div style="display:flex;align-items:center;gap:15px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <span style="font-size:30px;">${this.template?.icon || 'ğŸ“Š'}</span>
          <div>
            <div style="font-weight:600;">${this.template?.name || 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹'}</div>
            <div style="font-size:12px;color:var(--text-muted);">${this.template?.description || ''}</div>
          </div>
          <span class="tag tag-green" style="margin-left:auto;">ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½</span>
        </div>
      </div>
      
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin-bottom:15px;">ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ²Ğ¾Ñ€Ğ¾Ğ½ĞºĞ¸</h3>
        <table style="width:100%;font-size:13px;">
          <tr style="border-bottom:1px solid var(--border);">
            <th style="text-align:left;padding:10px 0;color:var(--text-muted);">Ğ­Ñ‚Ğ°Ğ¿</th>
            <th style="text-align:center;padding:10px 0;color:var(--text-muted);">ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²</th>
            <th style="text-align:right;padding:10px 0;color:var(--text-muted);">Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ</th>
          </tr>
          ${this.stages.map(s => `
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:10px 0;">${s.icon} ${s.name.replace(/^[^\s]+\s/, '')}</td>
              <td style="text-align:center;padding:10px 0;">${this.stats.byStage[s.code]?.length || 0}</td>
              <td style="text-align:right;padding:10px 0;color:var(--gold);">${s.target_conversion || 0}%</td>
            </tr>
          `).join('')}
        </table>
      </div>
      
      <div class="card">
        <h3 style="margin-bottom:15px;">ğŸ”§ Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-secondary" onclick="CRMApp.syncFromContacts()">ğŸ”„ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹</button>
          <button class="btn btn-secondary" onclick="location.reload()">ğŸ”ƒ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</button>
        </div>
      </div>
    `;
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // MODALS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  showAddContactModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'modal';
    modal.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <h2>â• ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚</h2>
          <button class="btn btn-secondary btn-sm" onclick="CRMApp.closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">Ğ˜Ğ¼Ñ *</label>
            <input type="text" class="input" id="contact-name" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚ *</label>
            <input type="text" class="input" id="contact-value" placeholder="+380... Ğ¸Ğ»Ğ¸ @username">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">ĞœĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€</label>
            <select class="input" id="contact-messenger">
              <option value="telegram">Telegram</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="viber">Viber</option>
              <option value="phone">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</option>
              <option value="email">Email</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ°</label>
            <textarea class="input" id="contact-notes" placeholder="Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="CRMApp.closeModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
          <button class="btn btn-primary" onclick="CRMApp.submitAddContact()">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },
  
  submitAddContact() {
    const name = document.getElementById('contact-name').value.trim();
    const contact = document.getElementById('contact-value').value.trim();
    const messenger = document.getElementById('contact-messenger').value;
    const notes = document.getElementById('contact-notes').value.trim();
    
    if (!name || !contact) {
      alert('Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ');
      return;
    }
    
    this.addContact({ name, contact, messenger, notes });
  },
  
  showAddTaskModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'modal';
    modal.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <h2>â• ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°</h2>
          <button class="btn btn-secondary btn-sm" onclick="CRMApp.closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ *</label>
            <input type="text" class="input" id="task-title" placeholder="Ğ§Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ?">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">Ğ”Ğ°Ñ‚Ğ°</label>
            <input type="date" class="input" id="task-date" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚</label>
            <select class="input" id="task-priority">
              <option value="normal">ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹</option>
              <option value="high">Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹</option>
              <option value="urgent">Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ñ‹Ğ¹</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)</label>
            <select class="input" id="task-contact">
              <option value="">Ğ‘ĞµĞ· Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ¸</option>
              ${this.contacts.map(c => `<option value="${c.id}">${c.name} (${c.contact})</option>`).join('')}
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ</label>
            <textarea class="input" id="task-desc" placeholder="ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="CRMApp.closeModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
          <button class="btn btn-primary" onclick="CRMApp.submitAddTask()">Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },
  
  submitAddTask() {
    const title = document.getElementById('task-title').value.trim();
    const due_date = document.getElementById('task-date').value;
    const priority = document.getElementById('task-priority').value;
    const contact_id = document.getElementById('task-contact').value || null;
    const description = document.getElementById('task-desc').value.trim();
    
    if (!title) {
      alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸');
      return;
    }
    
    this.addTask({ title, due_date, priority, contact_id, description });
  },
  
  showContactDetail(contactId) {
    const contact = this.contacts.find(c => c.id === contactId);
    if (!contact) return;
    
    const stage = this.stages.find(s => s.code === contact.stage_code);
    const stageMessages = this.messages.filter(m => m.stage_id === stage?.id);
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'modal';
    modal.innerHTML = `
      <div class="modal" style="max-width:700px;">
        <div class="modal-header">
          <div style="display:flex;align-items:center;gap:15px;">
            <div style="width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-dark));display:flex;align-items:center;justify-content:center;font-weight:600;color:#000;font-size:20px;">${(contact.name || '?')[0].toUpperCase()}</div>
            <div>
              <h2>${contact.name || 'Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸'}</h2>
              <div style="font-size:13px;color:var(--gold);">${contact.contact}</div>
            </div>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="CRMApp.closeModal()">âœ•</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-muted);">Ğ­Ñ‚Ğ°Ğ¿ Ğ²Ğ¾Ñ€Ğ¾Ğ½ĞºĞ¸</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              ${this.stages.map(s => `
                <button class="btn ${s.code === contact.stage_code ? 'btn-primary' : 'btn-secondary'} btn-sm" 
                        onclick="CRMApp.moveContactToStage('${contact.id}', '${s.code}');CRMApp.closeModal();">
                  ${s.icon} ${s.name.replace(/^[^\s]+\s/, '')}
                </button>
              `).join('')}
            </div>
          </div>
          
          ${stageMessages.length > 0 ? `
            <div style="margin-bottom:20px;">
              <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-muted);">ğŸ’¬ Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ğ¿Ğ°</label>
              ${stageMessages.map(m => `
                <div class="message-card" onclick="CRMApp.copyMessage(\`${m.content.replace(/`/g, "'").replace(/{name}/g, contact.name || '')}\`)">
                  <div class="title">${m.title}</div>
                  <div class="content">${m.content.replace(/{name}/g, contact.name || '').substring(0, 150)}...</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;font-size:13px;">
            <div><span style="color:var(--text-muted);">ĞœĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€:</span> ${contact.messenger || 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½'}</div>
            <div><span style="color:var(--text-muted);">Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°:</span> ${contact.temperature || 'warm'}</div>
            <div><span style="color:var(--text-muted);">Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº:</span> ${contact.source || 'manual'}</div>
            <div><span style="color:var(--text-muted);">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½:</span> ${this.formatDate(contact.created_at)}</div>
          </div>
          
          ${contact.notes ? `
            <div style="margin-top:15px;padding:15px;background:var(--bg-lighter);border-radius:8px;">
              <div style="font-size:12px;color:var(--text-muted);margin-bottom:5px;">ğŸ“ Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸</div>
              <div style="white-space:pre-wrap;font-size:13px;">${contact.notes}</div>
            </div>
          ` : ''}
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger btn-sm" onclick="CRMApp.deleteContact('${contact.id}')">ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
          <button class="btn btn-secondary" onclick="CRMApp.closeModal()">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },
  
  async deleteContact(contactId) {
    if (!confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚?')) return;
    
    await supabaseClient.from('crm_contacts').delete().eq('id', contactId);
    this.contacts = this.contacts.filter(c => c.id !== contactId);
    this.calculateStats();
    this.closeModal();
    this.render();
  },
  
  closeModal() {
    const modal = document.getElementById('modal');
    if (modal) modal.remove();
  },
  
  copyMessage(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert('âœ… Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ² Ğ±ÑƒÑ„ĞµÑ€ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°!');
    });
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // UTILS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  formatDate(dateStr) {
    if (!dateStr) return 'â€”';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU');
  },
  
  setSection(section) {
    this.activeSection = section;
    this.render();
  },
  
  bindEvents() {
    // Nav items
    document.querySelectorAll('.nav-item[data-section]').forEach(item => {
      item.onclick = () => {
        this.activeSection = item.dataset.section;
        this.render();
      };
    });
    
    // Search
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.oninput = (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.contact-row').forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      };
    }
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SCREENS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  showConnectScreen() {
    document.getElementById('app').innerHTML = `
      <div class="connect-screen">
        <div class="connect-card">
          <div style="font-size:60px;margin-bottom:20px;">ğŸ¯</div>
          <h1 style="font-size:28px;margin-bottom:10px;background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">CardGift CRM</h1>
          <p style="color:var(--text-muted);margin-bottom:30px;">Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ</p>
          <a href="dashboard.html" class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;text-decoration:none;justify-content:center;">ğŸ”— ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğ² ĞŸĞ°Ğ½ĞµĞ»ÑŒ</a>
        </div>
      </div>
    `;
  },
  
  showLoading() {
    document.getElementById('app').innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° CRM...</div>
      </div>
    `;
  },
  
  showError(message) {
    document.getElementById('app').innerHTML = `
      <div class="connect-screen">
        <div class="connect-card">
          <div style="font-size:60px;margin-bottom:20px;">âŒ</div>
          <h2 style="margin-bottom:15px;">${message}</h2>
          <button class="btn btn-primary" onclick="location.reload()">ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ</button>
        </div>
      </div>
    `;
  }
};

// Start
document.addEventListener('DOMContentLoaded', () => CRMApp.init());
</script>

</body>
</html>
