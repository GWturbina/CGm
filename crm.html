<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CardGift CRM v4.0</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--gold:#FFD700;--gold-dark:#B8860B;--bg-dark:#0f1419;--bg-card:#1a1f2e;--bg-lighter:#242b3d;--text:#E8E8E8;--text-muted:#9CA3AF;--accent:#00d4ff;--green:#4CAF50;--red:#f44336;--orange:#ff9800;--purple:#9c27b0;--border:rgba(255,215,0,0.2)}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:linear-gradient(135deg,var(--bg-dark),#1a1a2e,var(--bg-dark));color:var(--text);min-height:100vh}
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg-dark)}::-webkit-scrollbar-thumb{background:var(--gold-dark);border-radius:3px}
    
    .btn{padding:10px 16px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{transform:translateY(-1px);opacity:.9}.btn:active{transform:scale(.98)}
    .btn-primary{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#000}
    .btn-secondary{background:var(--bg-lighter);border:1px solid var(--border);color:var(--text)}
    .btn-success{background:rgba(76,175,80,.2);border:1px solid var(--green);color:var(--green)}
    .btn-danger{background:rgba(244,67,54,.2);border:1px solid var(--red);color:var(--red)}
    .btn-sm{padding:6px 12px;font-size:12px}
    
    .input{width:100%;padding:12px 14px;background:var(--bg-lighter);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px}
    .input:focus{outline:none;border-color:var(--gold)}
    textarea.input{min-height:100px;resize:vertical}
    select.input{cursor:pointer}
    
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px}
    .tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500}
    .tag-blue{background:rgba(0,212,255,.2);color:var(--accent)}
    .tag-orange{background:rgba(255,152,0,.2);color:var(--orange)}
    .tag-purple{background:rgba(156,39,176,.2);color:var(--purple)}
    .tag-gold{background:rgba(255,215,0,.2);color:var(--gold)}
    .tag-green{background:rgba(76,175,80,.2);color:var(--green)}
    .tag-red{background:rgba(244,67,54,.2);color:var(--red)}
    
    /* Layout */
    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;background:linear-gradient(180deg,var(--bg-card),var(--bg-dark));border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;height:100vh;z-index:50}
    .sidebar-header{padding:20px;border-bottom:1px solid var(--border)}
    .sidebar-nav{flex:1;padding:15px 10px;overflow-y:auto}
    .nav-section{font-size:10px;text-transform:uppercase;color:var(--text-muted);padding:15px 15px 8px;letter-spacing:1px}
    .nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;border-radius:10px;cursor:pointer;color:var(--text-muted);font-size:14px;transition:all .2s;margin-bottom:4px}
    .nav-item:hover{background:rgba(255,215,0,.1);color:var(--text)}
    .nav-item.active{background:rgba(255,215,0,.15);color:var(--gold)}
    .nav-item .icon{font-size:18px;width:24px;text-align:center}
    .nav-item .badge{margin-left:auto;background:var(--gold);color:#000;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600}
    
    .main{margin-left:260px;flex:1;min-height:100vh}
    .header{background:rgba(26,31,46,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:15px 25px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:40}
    .content{padding:25px}
    
    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:25px}
    .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px}
    .stat-card .icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:10px}
    .stat-card .value{font-size:26px;font-weight:700;color:var(--gold)}
    .stat-card .label{font-size:12px;color:var(--text-muted);margin-top:4px}
    
    /* Funnel */
    .funnel-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:15px}
    .funnel-stage{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;min-height:400px}
    .funnel-header{padding:15px;border-bottom:1px solid var(--border);text-align:center}
    .funnel-header .icon{font-size:24px;margin-bottom:5px}
    .funnel-header .name{font-size:13px;font-weight:600}
    .funnel-header .count{font-size:11px;color:var(--text-muted);margin-top:3px}
    .funnel-body{padding:10px;max-height:350px;overflow-y:auto}
    .funnel-card{background:var(--bg-lighter);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px;cursor:pointer;transition:all .2s}
    .funnel-card:hover{border-color:var(--gold);transform:translateY(-2px)}
    .funnel-card .name{font-weight:500;margin-bottom:4px;font-size:13px}
    .funnel-card .contact{font-size:11px;color:var(--gold)}
    .funnel-card .meta{font-size:10px;color:var(--text-muted);margin-top:6px}
    
    /* Tasks */
    .task-item{display:flex;align-items:center;gap:12px;padding:15px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;margin-bottom:10px}
    .task-item.completed{opacity:.6}
    .task-checkbox{width:22px;height:22px;border-radius:6px;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .task-checkbox.checked{background:var(--green);border-color:var(--green)}
    .task-checkbox.checked::after{content:'‚úì';color:#fff;font-size:12px}
    .task-content{flex:1}
    .task-title{font-size:14px;margin-bottom:4px}
    .task-meta{font-size:11px;color:var(--text-muted)}
    
    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:600px;max-height:90vh;overflow:auto}
    .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-body{padding:20px}
    .modal-footer{padding:15px 20px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    
    /* Messages */
    .message-card{background:var(--bg-lighter);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all .2s}
    .message-card:hover{border-color:var(--gold)}
    .message-card .title{font-weight:500;color:var(--gold);margin-bottom:8px;font-size:13px}
    .message-card .content{font-size:12px;color:var(--text-muted);line-height:1.5;white-space:pre-wrap}
    
    /* Contacts list */
    .contact-row{display:flex;align-items:center;gap:15px;padding:15px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;margin-bottom:10px;cursor:pointer;transition:all .2s}
    .contact-row:hover{border-color:var(--gold)}
    .contact-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-dark));display:flex;align-items:center;justify-content:center;font-weight:600;color:#000;font-size:16px}
    .contact-info{flex:1}
    .contact-info .name{font-weight:500;margin-bottom:3px}
    .contact-info .detail{font-size:12px;color:var(--text-muted)}
    .contact-actions{display:flex;gap:8px}
    
    /* Loading */
    .loading{text-align:center;padding:60px}
    .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Connect screen */
    .connect-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .connect-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:40px;text-align:center;max-width:450px;width:100%}
    
    /* Responsive */
    @media(max-width:1200px){.funnel-grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:768px){
      .sidebar{display:none}
      .main{margin-left:0}
      .funnel-grid{grid-template-columns:repeat(2,1fr)}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>

<div id="app"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CONFIG = {
  SUPABASE_URL: 'https://imgpysvdosdsqucoghqa.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImltZ3B5c3Zkb3Nkc3F1Y29naHFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTU0ODYsImV4cCI6MjA4MjEzMTQ4Nn0.HTRDARe0DkeyI4et9I5xcElToiHzrfJTr2kFpwoik0Y'
};

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Supabase
if (typeof window.supabase === 'undefined') {
  console.error('Supabase library not loaded!');
}

const supabaseClient = window.supabase ? window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY) : null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CRM APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const CRMApp = {
  // State
  userId: null,
  template: null,
  stages: [],
  autoTasks: [],
  messages: [],
  contacts: [],
  tasks: [],
  stats: {},
  activeSection: 'dashboard',
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // INIT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  async init() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É Supabase
    if (!supabaseClient) {
      this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Supabase');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ localStorage (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ dashboard)
    this.userId = localStorage.getItem('cardgift_gw_id') 
                || localStorage.getItem('cardgift_display_id')
                || localStorage.getItem('userGwId');
    
    if (!this.userId) {
      this.showConnectScreen();
      return;
    }
    
    // –£–±–∏—Ä–∞–µ–º GW –ø—Ä–µ—Ñ–∏–∫—Å
    this.userId = this.userId.toString().replace(/^GW/i, '');
    
    console.log('üöÄ CRM Init for user:', this.userId);
    
    this.showLoading();
    
    try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —à–∞–±–ª–æ–Ω
      await this.loadTemplate();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∑–∞–¥–∞—á–∏
      await this.loadContacts();
      await this.loadTasks();
      
      // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      this.calculateStats();
      
      // –†–µ–Ω–¥–µ—Ä–∏–º
      this.render();
      
    } catch (e) {
      console.error('CRM Init error:', e);
      this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CRM');
    }
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // LOAD DATA
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  async loadTemplate() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–∞–±–ª–æ–Ω
    const { data: template } = await supabaseClient
      .from('crm_templates')
      .select('*')
      .eq('template_type', 'system')
      .eq('is_active', true)
      .limit(1)
      .maybeSingle();
    
    this.template = template;
    
    if (template) {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç—Ç–∞–ø—ã
      const { data: stages } = await supabaseClient
        .from('crm_stages')
        .select('*')
        .eq('template_id', template.id)
        .order('sort_order');
      
      this.stages = stages || [];
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤—Ç–æ–∑–∞–¥–∞—á–∏
      const { data: autoTasks } = await supabaseClient
        .from('crm_auto_tasks')
        .select('*')
        .eq('template_id', template.id)
        .order('sort_order');
      
      this.autoTasks = autoTasks || [];
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
      const { data: messages } = await supabaseClient
        .from('crm_messages')
        .select('*')
        .eq('template_id', template.id)
        .order('sort_order');
      
      this.messages = messages || [];
    }
    
    console.log('üìä Loaded:', this.stages.length, 'stages,', this.autoTasks.length, 'tasks,', this.messages.length, 'messages');
  },
  
  async loadContacts() {
    const gwId = 'GW' + this.userId;
    
    const { data } = await supabaseClient
      .from('crm_contacts')
      .select('*')
      .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
      .eq('status', 'active')
      .order('updated_at', { ascending: false });
    
    this.contacts = data || [];
    console.log('üë• Loaded', this.contacts.length, 'contacts');
  },
  
  async loadTasks() {
    const gwId = 'GW' + this.userId;
    
    const { data } = await supabaseClient
      .from('crm_tasks')
      .select('*, contact:crm_contact_id(name, contact)')
      .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
      .eq('status', 'pending')
      .order('due_date');
    
    this.tasks = data || [];
    console.log('üìã Loaded', this.tasks.length, 'tasks');
  },
  
  calculateStats() {
    const byStage = {};
    this.stages.forEach(s => { byStage[s.code] = []; });
    
    this.contacts.forEach(c => {
      if (byStage[c.stage_code]) {
        byStage[c.stage_code].push(c);
      }
    });
    
    const today = new Date().toISOString().split('T')[0];
    const todayTasks = this.tasks.filter(t => t.due_date === today);
    const overdueTasks = this.tasks.filter(t => t.due_date && t.due_date < today);
    const converted = this.contacts.filter(c => c.is_converted).length;
    
    this.stats = {
      totalContacts: this.contacts.length,
      converted,
      conversionRate: this.contacts.length > 0 ? (converted / this.contacts.length * 100).toFixed(1) : 0,
      pendingTasks: this.tasks.length,
      todayTasks: todayTasks.length,
      overdueTasks: overdueTasks.length,
      byStage
    };
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SYNC FROM CONTACTS TABLE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  async syncFromContacts() {
    const gwId = 'GW' + this.userId;
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã contacts
    const { data: sourceContacts } = await supabaseClient
      .from('contacts')
      .select('*')
      .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
      .neq('status', 'archived');
    
    if (!sourceContacts || sourceContacts.length === 0) {
      alert('–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
      return;
    }
    
    let imported = 0;
    let skipped = 0;
    
    for (const sc of sourceContacts) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
      const { data: existing } = await supabaseClient
        .from('crm_contacts')
        .select('id')
        .or(`owner_gw_id.eq.${this.userId},owner_gw_id.eq.${gwId}`)
        .eq('contact', sc.contact)
        .maybeSingle();
      
      if (existing) {
        skipped++;
        continue;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ CRM
      await supabaseClient.from('crm_contacts').insert({
        contact_id: sc.id,
        owner_gw_id: this.userId,
        name: sc.name,
        contact: sc.contact,
        messenger: sc.messenger,
        stage_code: 'new',
        stage_entered_at: new Date().toISOString(),
        source: sc.source || 'contacts_sync',
        status: 'active',
        temperature: 'warm',
        stage_history: JSON.stringify([{
          stage: 'new',
          entered_at: new Date().toISOString(),
          action: 'imported'
        }])
      });
      
      imported++;
    }
    
    alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${imported}\n–ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏–∫–∞—Ç—ã): ${skipped}`);
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
    await this.loadContacts();
    this.calculateStats();
    this.render();
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CONTACT ACTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  async addContact(data) {
    const contact = {
      owner_gw_id: this.userId,
      name: data.name,
      contact: data.contact,
      messenger: data.messenger,
      stage_code: 'new',
      stage_entered_at: new Date().toISOString(),
      source: 'manual',
      status: 'active',
      temperature: data.temperature || 'warm',
      notes: data.notes || '',
      stage_history: JSON.stringify([{
        stage: 'new',
        entered_at: new Date().toISOString(),
        action: 'created'
      }])
    };
    
    const { data: newContact, error } = await supabaseClient
      .from('crm_contacts')
      .insert(contact)
      .select()
      .single();
    
    if (error) {
      alert('–û—à–∏–±–∫–∞: ' + error.message);
      return;
    }
    
    // –°–æ–∑–¥–∞—ë–º –∞–≤—Ç–æ–∑–∞–¥–∞—á–∏ –¥–ª—è —ç—Ç–∞–ø–∞ "new"
    await this.createAutoTasksForContact(newContact.id, 'new');
    
    this.contacts.unshift(newContact);
    this.calculateStats();
    this.closeModal();
    this.render();
  },
  
  async moveContactToStage(contactId, newStage) {
    const contact = this.contacts.find(c => c.id === contactId);
    if (!contact) return;
    
    const oldStage = contact.stage_code;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
    let history = [];
    try { history = JSON.parse(contact.stage_history || '[]'); } catch(e) {}
    history.push({
      stage: newStage,
      from: oldStage,
      entered_at: new Date().toISOString()
    });
    
    await supabaseClient
      .from('crm_contacts')
      .update({
        stage_code: newStage,
        stage_entered_at: new Date().toISOString(),
        stage_history: JSON.stringify(history),
        updated_at: new Date().toISOString()
      })
      .eq('id', contactId);
    
    // –°–æ–∑–¥–∞—ë–º –∞–≤—Ç–æ–∑–∞–¥–∞—á–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç—Ç–∞–ø–∞
    await this.createAutoTasksForContact(contactId, newStage);
    
    // –ï—Å–ª–∏ "active" - –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
    if (newStage === 'active') {
      await supabaseClient
        .from('crm_contacts')
        .update({
          is_converted: true,
          converted_at: new Date().toISOString(),
          status: 'converted'
        })
        .eq('id', contactId);
    }
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
    await this.loadContacts();
    await this.loadTasks();
    this.calculateStats();
    this.render();
  },
  
  async createAutoTasksForContact(contactId, stageCode) {
    const stage = this.stages.find(s => s.code === stageCode);
    if (!stage) return;
    
    const stageTasks = this.autoTasks.filter(t => t.stage_id === stage.id && t.trigger_type === 'on_enter');
    
    for (const at of stageTasks) {
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + (at.due_days || 1));
      
      await supabaseClient.from('crm_tasks').insert({
        owner_gw_id: this.userId,
        crm_contact_id: contactId,
        title: at.title,
        description: at.description,
        icon: at.icon,
        task_type: 'auto',
        auto_task_id: at.id,
        due_date: dueDate.toISOString().split('T')[0],
        priority: at.priority,
        status: 'pending'
      });
    }
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TASK ACTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  async addTask(data) {
    const task = {
      owner_gw_id: this.userId,
      crm_contact_id: data.contact_id || null,
      title: data.title,
      description: data.description || '',
      icon: 'üìã',
      task_type: 'manual',
      due_date: data.due_date,
      priority: data.priority || 'normal',
      status: 'pending'
    };
    
    const { data: newTask, error } = await supabaseClient
      .from('crm_tasks')
      .insert(task)
      .select()
      .single();
    
    if (!error) {
      this.tasks.push(newTask);
      this.closeModal();
      this.render();
    }
  },
  
  async completeTask(taskId) {
    await supabaseClient
      .from('crm_tasks')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString()
      })
      .eq('id', taskId);
    
    this.tasks = this.tasks.filter(t => t.id !== taskId);
    this.calculateStats();
    this.render();
  },
  
  async deleteTask(taskId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
    
    await supabaseClient.from('crm_tasks').delete().eq('id', taskId);
    this.tasks = this.tasks.filter(t => t.id !== taskId);
    this.render();
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  render() {
    const app = document.getElementById('app');
    
    app.innerHTML = `
      <div class="app">
        ${this.renderSidebar()}
        <main class="main">
          ${this.renderHeader()}
          <div class="content">
            ${this.renderContent()}
          </div>
        </main>
      </div>
    `;
    
    this.bindEvents();
  },
  
  renderSidebar() {
    const navItems = [
      { id: 'dashboard', icon: 'üìà', text: '–î–∞—à–±–æ—Ä–¥' },
      { id: 'funnel', icon: 'üéØ', text: '–í–æ—Ä–æ–Ω–∫–∞', badge: this.contacts.length },
      { id: 'contacts', icon: 'üë•', text: '–ö–æ–Ω—Ç–∞–∫—Ç—ã' },
      { id: 'tasks', icon: '‚úÖ', text: '–ó–∞–¥–∞—á–∏', badge: this.tasks.length },
      { id: 'messages', icon: 'üí¨', text: '–®–∞–±–ª–æ–Ω—ã' },
      { id: 'settings', icon: '‚öôÔ∏è', text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' },
      { id: 'help', icon: 'üìñ', text: '–°–ø—Ä–∞–≤–∫–∞' }
    ];
    
    return `
      <aside class="sidebar">
        <div class="sidebar-header">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:28px;">üéØ</span>
            <div>
              <div style="font-size:18px;font-weight:700;color:var(--gold);">CardGift CRM</div>
              <div style="font-size:10px;color:var(--text-muted);">v4.0</div>
            </div>
          </div>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
          ${navItems.map(item => `
            <div class="nav-item ${this.activeSection === item.id ? 'active' : ''}" data-section="${item.id}">
              <span class="icon">${item.icon}</span>
              <span>${item.text}</span>
              ${item.badge ? `<span class="badge">${item.badge}</span>` : ''}
            </div>
          `).join('')}
        </nav>
        <div style="padding:15px;border-top:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:10px;">ID: ${this.userId}</div>
          <a href="dashboard.html" class="btn btn-secondary btn-sm" style="width:100%;text-decoration:none;justify-content:center;">‚Üê –ü–∞–Ω–µ–ª—å</a>
        </div>
      </aside>
    `;
  },
  
  renderHeader() {
    const titles = {
      dashboard: 'üìà –î–∞—à–±–æ—Ä–¥',
      funnel: 'üéØ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂',
      contacts: 'üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã',
      tasks: '‚úÖ –ó–∞–¥–∞—á–∏',
      messages: 'üí¨ –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π',
      settings: '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
      help: 'üìñ –°–ø—Ä–∞–≤–∫–∞'
    };
    
    return `
      <header class="header">
        <h1 style="font-size:20px;">${titles[this.activeSection] || ''}</h1>
        <div style="display:flex;gap:10px;">
          ${this.activeSection === 'contacts' || this.activeSection === 'funnel' ? `
            <button class="btn btn-secondary" onclick="CRMApp.syncFromContacts()">üîÑ –ò–º–ø–æ—Ä—Ç</button>
            <button class="btn btn-primary" onclick="CRMApp.showAddContactModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          ` : ''}
          ${this.activeSection === 'tasks' ? `
            <button class="btn btn-primary" onclick="CRMApp.showAddTaskModal()">‚ûï –ó–∞–¥–∞—á–∞</button>
          ` : ''}
        </div>
      </header>
    `;
  },
  
  renderContent() {
    switch (this.activeSection) {
      case 'dashboard': return this.renderDashboard();
      case 'funnel': return this.renderFunnel();
      case 'contacts': return this.renderContacts();
      case 'tasks': return this.renderTasks();
      case 'messages': return this.renderMessages();
      case 'settings': return this.renderSettings();
      case 'help': return this.renderHelp();
      default: return '';
    }
  },
  
  renderDashboard() {
    return `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="icon" style="background:rgba(0,212,255,.2);">üë•</div>
          <div class="value">${this.stats.totalContacts}</div>
          <div class="label">–í—Å–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background:rgba(76,175,80,.2);">üöÄ</div>
          <div class="value">${this.stats.converted}</div>
          <div class="label">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background:rgba(255,215,0,.2);">üìä</div>
          <div class="value">${this.stats.conversionRate}%</div>
          <div class="label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
        </div>
        <div class="stat-card">
          <div class="icon" style="background:rgba(255,152,0,.2);">‚úÖ</div>
          <div class="value">${this.stats.pendingTasks}</div>
          <div class="label">–ó–∞–¥–∞—á</div>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="card">
          <h3 style="margin-bottom:15px;">üéØ –í–æ—Ä–æ–Ω–∫–∞</h3>
          ${this.stages.map(stage => {
            const count = this.stats.byStage[stage.code]?.length || 0;
            const percent = this.stats.totalContacts > 0 ? (count / this.stats.totalContacts * 100).toFixed(0) : 0;
            return `
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                <span style="font-size:18px;">${stage.icon}</span>
                <span style="flex:1;font-size:13px;">${stage.name.replace(/^[^\s]+\s/, '')}</span>
                <span class="tag tag-gold">${count}</span>
                <span style="font-size:11px;color:var(--text-muted);width:40px;">${percent}%</span>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="card">
          <h3 style="margin-bottom:15px;">üìã –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
          ${this.stats.todayTasks === 0 ? `
            <div style="text-align:center;padding:20px;color:var(--text-muted);">
              <div style="font-size:30px;margin-bottom:10px;">üéâ</div>
              –ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
            </div>
          ` : this.tasks.filter(t => t.due_date === new Date().toISOString().split('T')[0]).slice(0, 5).map(t => `
            <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
              <span class="tag tag-${t.priority === 'urgent' ? 'red' : t.priority === 'high' ? 'orange' : 'blue'}" style="width:8px;height:8px;padding:0;border-radius:50%;"></span>
              <span style="flex:1;font-size:13px;">${t.title}</span>
              ${t.contact ? `<span style="font-size:11px;color:var(--text-muted);">${t.contact.name}</span>` : ''}
            </div>
          `).join('')}
          ${this.stats.overdueTasks > 0 ? `
            <div style="margin-top:15px;padding:10px;background:rgba(244,67,54,.1);border-radius:8px;font-size:12px;color:var(--red);">
              ‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: ${this.stats.overdueTasks} –∑–∞–¥–∞—á
            </div>
          ` : ''}
        </div>
      </div>
      
      <div class="card" style="margin-top:20px;">
        <h3 style="margin-bottom:15px;">üöÄ –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="CRMApp.showAddContactModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
          <button class="btn btn-secondary" onclick="CRMApp.showAddTaskModal()">üìã –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
          <button class="btn btn-secondary" onclick="CRMApp.syncFromContacts()">üîÑ –ò–º–ø–æ—Ä—Ç –∏–∑ –æ–ø—Ä–æ—Å–æ–≤</button>
          <button class="btn btn-secondary" onclick="CRMApp.setSection('funnel')">üéØ –í–æ—Ä–æ–Ω–∫–∞</button>
        </div>
      </div>
    `;
  },
  
  renderFunnel() {
    return `
      <div class="funnel-grid">
        ${this.stages.map(stage => {
          const contacts = this.stats.byStage[stage.code] || [];
          return `
            <div class="funnel-stage">
              <div class="funnel-header" style="border-left:3px solid var(--${stage.color || 'gold'});">
                <div class="icon">${stage.icon}</div>
                <div class="name">${stage.name.replace(/^[^\s]+\s/, '')}</div>
                <div class="count">${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
              </div>
              <div class="funnel-body">
                ${contacts.length === 0 ? `
                  <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px;">
                    –ü—É—Å—Ç–æ
                  </div>
                ` : contacts.map(c => `
                  <div class="funnel-card" onclick="CRMApp.showContactDetail('${c.id}')">
                    <div class="name">${c.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                    <div class="contact">${c.contact}</div>
                    <div class="meta">${c.messenger || ''} ‚Ä¢ ${this.formatDate(c.stage_entered_at)}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  },
  
  renderContacts() {
    return `
      <div style="margin-bottom:20px;">
        <input type="text" class="input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç—É..." id="search-input" style="max-width:400px;">
      </div>
      
      ${this.contacts.length === 0 ? `
        <div class="card" style="text-align:center;padding:40px;">
          <div style="font-size:50px;margin-bottom:15px;">üë•</div>
          <h3 style="margin-bottom:10px;">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h3>
          <p style="color:var(--text-muted);margin-bottom:20px;">–î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏–∑ –æ–ø—Ä–æ—Å–æ–≤</p>
          <button class="btn btn-primary" onclick="CRMApp.syncFromContacts()">üîÑ –ò–º–ø–æ—Ä—Ç –∏–∑ –æ–ø—Ä–æ—Å–æ–≤</button>
        </div>
      ` : this.contacts.map(c => {
        const stage = this.stages.find(s => s.code === c.stage_code);
        return `
          <div class="contact-row" onclick="CRMApp.showContactDetail('${c.id}')">
            <div class="contact-avatar">${(c.name || '?')[0].toUpperCase()}</div>
            <div class="contact-info">
              <div class="name">${c.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
              <div class="detail">${c.contact} ‚Ä¢ ${c.messenger || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
            </div>
            <span class="tag tag-${stage?.color || 'blue'}">${stage?.icon || ''} ${stage?.name?.replace(/^[^\s]+\s/, '') || c.stage_code}</span>
          </div>
        `;
      }).join('')}
    `;
  },
  
  renderTasks() {
    const today = new Date().toISOString().split('T')[0];
    
    return `
      ${this.tasks.length === 0 ? `
        <div class="card" style="text-align:center;padding:40px;">
          <div style="font-size:50px;margin-bottom:15px;">‚úÖ</div>
          <h3 style="margin-bottom:10px;">–ù–µ—Ç –∑–∞–¥–∞—á</h3>
          <p style="color:var(--text-muted);margin-bottom:20px;">–ó–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏</p>
          <button class="btn btn-primary" onclick="CRMApp.showAddTaskModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>
      ` : this.tasks.map(t => {
        const isOverdue = t.due_date && t.due_date < today;
        return `
          <div class="task-item ${t.status === 'completed' ? 'completed' : ''}">
            <div class="task-checkbox ${t.status === 'completed' ? 'checked' : ''}" onclick="CRMApp.completeTask('${t.id}')"></div>
            <div class="task-content">
              <div class="task-title">${t.icon || 'üìã'} ${t.title}</div>
              <div class="task-meta">
                ${t.contact ? `üë§ ${t.contact.name} ‚Ä¢ ` : ''}
                üìÖ ${this.formatDate(t.due_date)}
                ${isOverdue ? ' <span style="color:var(--red);">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>' : ''}
              </div>
            </div>
            <span class="tag tag-${t.priority === 'urgent' ? 'red' : t.priority === 'high' ? 'orange' : 'blue'}">${t.priority}</span>
            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();CRMApp.deleteTask('${t.id}')">üóëÔ∏è</button>
          </div>
        `;
      }).join('')}
    `;
  },
  
  renderMessages() {
    return `
      <p style="color:var(--text-muted);margin-bottom:20px;">
        –ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ –≤–æ—Ä–æ–Ω–∫–∏. –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.
      </p>
      
      ${this.stages.map(stage => {
        const stageMessages = this.messages.filter(m => m.stage_id === stage.id);
        if (stageMessages.length === 0) return '';
        
        return `
          <div class="card" style="margin-bottom:20px;">
            <h3 style="margin-bottom:15px;">${stage.icon} ${stage.name}</h3>
            ${stageMessages.map(m => `
              <div class="message-card" onclick="CRMApp.copyMessage(\`${m.content.replace(/`/g, "'")}\`)">
                <div class="title">${m.title}</div>
                <div class="content">${m.content.substring(0, 200)}${m.content.length > 200 ? '...' : ''}</div>
              </div>
            `).join('')}
          </div>
        `;
      }).join('')}
    `;
  },
  
  renderSettings() {
    return `
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin-bottom:15px;">üéØ –¢–µ–∫—É—â–∏–π —à–∞–±–ª–æ–Ω CRM</h3>
        <div style="display:flex;align-items:center;gap:15px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <span style="font-size:30px;">${this.template?.icon || 'üìä'}</span>
          <div>
            <div style="font-weight:600;">${this.template?.name || '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π'}</div>
            <div style="font-size:12px;color:var(--text-muted);">${this.template?.description || ''}</div>
          </div>
          <span class="tag tag-green" style="margin-left:auto;">–ê–∫—Ç–∏–≤–µ–Ω</span>
        </div>
      </div>
      
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin-bottom:15px;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–æ—Ä–æ–Ω–∫–∏</h3>
        <table style="width:100%;font-size:13px;">
          <tr style="border-bottom:1px solid var(--border);">
            <th style="text-align:left;padding:10px 0;color:var(--text-muted);">–≠—Ç–∞–ø</th>
            <th style="text-align:center;padding:10px 0;color:var(--text-muted);">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤</th>
            <th style="text-align:right;padding:10px 0;color:var(--text-muted);">–¶–µ–ª–µ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</th>
          </tr>
          ${this.stages.map(s => `
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:10px 0;">${s.icon} ${s.name.replace(/^[^\s]+\s/, '')}</td>
              <td style="text-align:center;padding:10px 0;">${this.stats.byStage[s.code]?.length || 0}</td>
              <td style="text-align:right;padding:10px 0;color:var(--gold);">${s.target_conversion || 0}%</td>
            </tr>
          `).join('')}
        </table>
      </div>
      
      <div class="card">
        <h3 style="margin-bottom:15px;">üîß –î–µ–π—Å—Ç–≤–∏—è</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-secondary" onclick="CRMApp.syncFromContacts()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã</button>
          <button class="btn btn-secondary" onclick="location.reload()">üîÉ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
      </div>
    `;
  },
  
  renderHelp() {
    return `
      <div class="card" style="margin-bottom:20px;background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,165,0,.05));border-color:var(--gold);">
        <h2 style="color:var(--gold);margin-bottom:10px;">üéØ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h2>
        <p style="color:var(--text-muted);line-height:1.6;">
          CRM –ø–æ–º–æ–≥–∞–µ—Ç –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –∏ –∑–Ω–∞—Ç—å —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –∫–∞–∂–¥—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.
          –í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –≤–æ—Ä–æ–Ω–∫—É: –æ—Ç "–ù–æ–≤–æ–≥–æ" –¥–æ "–ê–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞".
        </p>
      </div>
      
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin-bottom:15px;">üìä –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ - 6 —ç—Ç–∞–ø–æ–≤</h3>
        
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-size:16px;font-weight:600;color:var(--gold);margin-bottom:8px;">üÜï 1. –ù–æ–≤—ã–π</div>
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">–ö–æ–Ω—Ç–∞–∫—Ç —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–µ–Ω. <strong>–î–µ–π—Å—Ç–≤—É–π –±—ã—Å—Ç—Ä–æ!</strong></p>
          <div style="font-size:12px;color:var(--text);">‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤</div>
        </div>
        
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-size:16px;font-weight:600;color:var(--orange);margin-bottom:8px;">üëÄ 2. –ò–Ω—Ç–µ—Ä–µ—Å</div>
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">–ß–µ–ª–æ–≤–µ–∫ –æ—Ç–≤–µ—Ç–∏–ª –∏ —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ.</p>
          <div style="font-size:12px;color:var(--text);">‚úÖ –í—ã—Å–ª–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ CardGift<br>‚úÖ –ù–∞–∑–Ω–∞—á–∏—Ç—å –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏</div>
        </div>
        
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-size:16px;font-weight:600;color:var(--purple);margin-bottom:8px;">üìä 3. –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è</div>
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">–ß–µ–ª–æ–≤–µ–∫ —Å–º–æ—Ç—Ä–∏—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é.</p>
          <div style="font-size:12px;color:var(--text);">‚úÖ –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é<br>‚úÖ –°–ø—Ä–æ—Å–∏—Ç—å –∫–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã</div>
        </div>
        
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-size:16px;font-weight:600;color:var(--gold);margin-bottom:8px;">ü§î 4. –í–æ–∑—Ä–∞–∂–µ–Ω–∏—è</div>
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">–ï—Å—Ç—å —Å–æ–º–Ω–µ–Ω–∏—è –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã.</p>
          <div style="font-size:12px;color:var(--text);">‚úÖ –í—ã—è—Å–Ω–∏—Ç—å —á—Ç–æ —Å–º—É—â–∞–µ—Ç<br>‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤</div>
        </div>
        
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-size:16px;font-weight:600;color:var(--green);margin-bottom:8px;">üìù 5. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">–ì–æ—Ç–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è!</p>
          <div style="font-size:12px;color:var(--text);">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É<br>‚úÖ –ü–æ–º–æ—á—å —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</div>
        </div>
        
        <div style="padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-size:16px;font-weight:600;color:var(--green);margin-bottom:8px;">üöÄ 6. –ê–∫—Ç–∏–≤–Ω—ã–π</div>
          <p style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">–ü–∞—Ä—Ç–Ω—ë—Ä –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω! üéâ</p>
          <div style="font-size:12px;color:var(--text);">‚úÖ –ü–æ–∑–¥—Ä–∞–≤–∏—Ç—å<br>‚úÖ –ü–æ–º–æ—á—å —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –æ—Ç–∫—Ä—ã—Ç–∫—É<br>‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–º–∞–Ω–¥–Ω—ã–π —á–∞—Ç</div>
        </div>
      </div>
      
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin-bottom:15px;">üí° –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å CRM</h3>
        
        <div style="margin-bottom:15px;">
          <div style="font-weight:600;color:var(--gold);margin-bottom:5px;">1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>
          <p style="font-size:13px;color:var(--text-muted);">–ö–Ω–æ–ø–∫–∞ "üîÑ –ò–º–ø–æ—Ä—Ç" –ø–µ—Ä–µ–Ω–µ—Å—ë—Ç –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ –≤–∞—à–∏—Ö –æ–ø—Ä–æ—Å–æ–≤.</p>
        </div>
        
        <div style="margin-bottom:15px;">
          <div style="font-weight:600;color:var(--gold);margin-bottom:5px;">2. –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞—á–∏</div>
          <p style="font-size:13px;color:var(--text-muted);">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞. –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∏—Ö –ø–æ –ø–æ—Ä—è–¥–∫—É.</p>
        </div>
        
        <div style="margin-bottom:15px;">
          <div style="font-weight:600;color:var(--gold);margin-bottom:5px;">3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∞–±–ª–æ–Ω—ã</div>
          <p style="font-size:13px;color:var(--text-muted);">–ì–æ—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —à–∞–±–ª–æ–Ω - –æ–Ω —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è.</p>
        </div>
        
        <div style="margin-bottom:15px;">
          <div style="font-weight:600;color:var(--gold);margin-bottom:5px;">4. –ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –ø–æ –≤–æ—Ä–æ–Ω–∫–µ</div>
          <p style="font-size:13px;color:var(--text-muted);">–ö–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –≥–æ—Ç–æ–≤ - –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø.</p>
        </div>
      </div>
      
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin-bottom:15px;">ü§î –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è</h3>
        
        <div style="margin-bottom:15px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-weight:600;margin-bottom:8px;">"–£ –º–µ–Ω—è –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏"</div>
          <p style="font-size:12px;color:var(--text-muted);">CardGift –∑–∞–Ω–∏–º–∞–µ—Ç 5-10 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ 24/7. –ù–∞—á–∞—Ç—å –º–æ–∂–Ω–æ —Å 30 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å.</p>
        </div>
        
        <div style="margin-bottom:15px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-weight:600;margin-bottom:8px;">"–Ø –Ω–µ —É–º–µ—é –ø—Ä–æ–¥–∞–≤–∞—Ç—å"</div>
          <p style="font-size:12px;color:var(--text-muted);">–ó–¥–µ—Å—å –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–∞–≤–∞—Ç—å! –í—ã –¥–µ–ª–∏—Ç–µ—Å—å –æ—Ç–∫—Ä—ã—Ç–∫–∞–º–∏ –∏ –æ–ø—Ä–æ—Å–∞–º–∏. –≠—Ç–æ –∫–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥—Ä—É–≥–∞.</p>
        </div>
        
        <div style="margin-bottom:15px;padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-weight:600;margin-bottom:8px;">"–≠—Ç–æ –ø–∏—Ä–∞–º–∏–¥–∞?"</div>
          <p style="font-size:12px;color:var(--text-muted);">–ù–µ—Ç! –ï—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç (–æ—Ç–∫—Ä—ã—Ç–∫–∏), –¥–æ—Ö–æ–¥ –æ—Ç —Ä–µ–∫–ª–∞–º—ã –∏ –ø–æ–¥–ø–∏—Å–æ–∫. –≠—Ç–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –∫–∞–∫ Dropbox.</p>
        </div>
        
        <div style="padding:15px;background:var(--bg-lighter);border-radius:10px;">
          <div style="font-weight:600;margin-bottom:8px;">"–ú–Ω–µ –Ω—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å"</div>
          <p style="font-size:12px;color:var(--text-muted);">–û—Ç–ª–∏—á–Ω–æ! –ü–æ–∫–∞ –¥—É–º–∞–µ—Ç–µ - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –°–æ–∑–¥–∞–π—Ç–µ –æ–¥–Ω—É –æ—Ç–∫—Ä—ã—Ç–∫—É –±–µ–∑ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤.</p>
        </div>
      </div>
      
      <div class="card">
        <h3 style="margin-bottom:15px;">‚è∞ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä—É—Ç–∏–Ω–∞ (15-30 –º–∏–Ω—É—Ç)</h3>
        <div style="font-size:13px;line-height:1.8;color:var(--text-muted);">
          <strong style="color:var(--text);">–£—Ç—Ä–æ:</strong> –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è<br>
          <strong style="color:var(--text);">–î–µ–Ω—å:</strong> –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞—á–∏, –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã<br>
          <strong style="color:var(--text);">–í–µ—á–µ—Ä:</strong> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, –ø–ª–∞–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞
        </div>
        <div style="margin-top:15px;padding:12px;background:rgba(255,215,0,.1);border-radius:8px;font-size:13px;color:var(--gold);">
          üí° <strong>–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:</strong> –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–µ–ª–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–∞–∂–¥—ã–º –∞–∫—Ç–∏–≤–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º!
        </div>
      </div>
    `;
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MODALS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  showAddContactModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'modal';
    modal.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <h2>‚ûï –ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</h2>
          <button class="btn btn-secondary btn-sm" onclick="CRMApp.closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–ò–º—è *</label>
            <input type="text" class="input" id="contact-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–ö–æ–Ω—Ç–∞–∫—Ç *</label>
            <input type="text" class="input" id="contact-value" placeholder="+380... –∏–ª–∏ @username">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</label>
            <select class="input" id="contact-messenger">
              <option value="telegram">Telegram</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="viber">Viber</option>
              <option value="phone">–¢–µ–ª–µ—Ñ–æ–Ω</option>
              <option value="email">Email</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–ó–∞–º–µ—Ç–∫–∞</label>
            <textarea class="input" id="contact-notes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="CRMApp.closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" onclick="CRMApp.submitAddContact()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },
  
  submitAddContact() {
    const name = document.getElementById('contact-name').value.trim();
    const contact = document.getElementById('contact-value').value.trim();
    const messenger = document.getElementById('contact-messenger').value;
    const notes = document.getElementById('contact-notes').value.trim();
    
    if (!name || !contact) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }
    
    this.addContact({ name, contact, messenger, notes });
  },
  
  showAddTaskModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'modal';
    modal.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <h2>‚ûï –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
          <button class="btn btn-secondary btn-sm" onclick="CRMApp.closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
            <input type="text" class="input" id="task-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–î–∞—Ç–∞</label>
            <input type="date" class="input" id="task-date" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
            <select class="input" id="task-priority">
              <option value="normal">–û–±—ã—á–Ω—ã–π</option>
              <option value="high">–í—ã—Å–æ–∫–∏–π</option>
              <option value="urgent">–°—Ä–æ—á–Ω—ã–π</option>
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–ö–æ–Ω—Ç–∞–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <select class="input" id="task-contact">
              <option value="">–ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏</option>
              ${this.contacts.map(c => `<option value="${c.id}">${c.name} (${c.contact})</option>`).join('')}
            </select>
          </div>
          <div style="margin-bottom:15px;">
            <label style="display:block;margin-bottom:5px;font-size:13px;color:var(--text-muted);">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="input" id="task-desc" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="CRMApp.closeModal()">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" onclick="CRMApp.submitAddTask()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },
  
  submitAddTask() {
    const title = document.getElementById('task-title').value.trim();
    const due_date = document.getElementById('task-date').value;
    const priority = document.getElementById('task-priority').value;
    const contact_id = document.getElementById('task-contact').value || null;
    const description = document.getElementById('task-desc').value.trim();
    
    if (!title) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
      return;
    }
    
    this.addTask({ title, due_date, priority, contact_id, description });
  },
  
  showContactDetail(contactId) {
    const contact = this.contacts.find(c => c.id === contactId);
    if (!contact) return;
    
    const stage = this.stages.find(s => s.code === contact.stage_code);
    const stageMessages = this.messages.filter(m => m.stage_id === stage?.id);
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'modal';
    modal.innerHTML = `
      <div class="modal" style="max-width:700px;">
        <div class="modal-header">
          <div style="display:flex;align-items:center;gap:15px;">
            <div style="width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-dark));display:flex;align-items:center;justify-content:center;font-weight:600;color:#000;font-size:20px;">${(contact.name || '?')[0].toUpperCase()}</div>
            <div>
              <h2>${contact.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</h2>
              <div style="font-size:13px;color:var(--gold);">${contact.contact}</div>
            </div>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="CRMApp.closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-muted);">–≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              ${this.stages.map(s => `
                <button class="btn ${s.code === contact.stage_code ? 'btn-primary' : 'btn-secondary'} btn-sm" 
                        onclick="CRMApp.moveContactToStage('${contact.id}', '${s.code}');CRMApp.closeModal();">
                  ${s.icon} ${s.name.replace(/^[^\s]+\s/, '')}
                </button>
              `).join('')}
            </div>
          </div>
          
          ${stageMessages.length > 0 ? `
            <div style="margin-bottom:20px;">
              <label style="display:block;margin-bottom:8px;font-size:13px;color:var(--text-muted);">üí¨ –®–∞–±–ª–æ–Ω—ã –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞</label>
              ${stageMessages.map(m => `
                <div class="message-card" onclick="CRMApp.copyMessage(\`${m.content.replace(/`/g, "'").replace(/{name}/g, contact.name || '')}\`)">
                  <div class="title">${m.title}</div>
                  <div class="content">${m.content.replace(/{name}/g, contact.name || '').substring(0, 150)}...</div>
                </div>
              `).join('')}
            </div>
          ` : ''}
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;font-size:13px;">
            <div><span style="color:var(--text-muted);">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä:</span> ${contact.messenger || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
            <div><span style="color:var(--text-muted);">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span> ${contact.temperature || 'warm'}</div>
            <div><span style="color:var(--text-muted);">–ò—Å—Ç–æ—á–Ω–∏–∫:</span> ${contact.source || 'manual'}</div>
            <div><span style="color:var(--text-muted);">–î–æ–±–∞–≤–ª–µ–Ω:</span> ${this.formatDate(contact.created_at)}</div>
          </div>
          
          ${contact.notes ? `
            <div style="margin-top:15px;padding:15px;background:var(--bg-lighter);border-radius:8px;">
              <div style="font-size:12px;color:var(--text-muted);margin-bottom:5px;">üìù –ó–∞–º–µ—Ç–∫–∏</div>
              <div style="white-space:pre-wrap;font-size:13px;">${contact.notes}</div>
            </div>
          ` : ''}
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger btn-sm" onclick="CRMApp.deleteContact('${contact.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn btn-secondary" onclick="CRMApp.closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  },
  
  async deleteContact(contactId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç?')) return;
    
    await supabaseClient.from('crm_contacts').delete().eq('id', contactId);
    this.contacts = this.contacts.filter(c => c.id !== contactId);
    this.calculateStats();
    this.closeModal();
    this.render();
  },
  
  closeModal() {
    const modal = document.getElementById('modal');
    if (modal) modal.remove();
  },
  
  copyMessage(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // UTILS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  formatDate(dateStr) {
    if (!dateStr) return '‚Äî';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ru-RU');
  },
  
  setSection(section) {
    this.activeSection = section;
    this.render();
  },
  
  bindEvents() {
    // Nav items
    document.querySelectorAll('.nav-item[data-section]').forEach(item => {
      item.onclick = () => {
        this.activeSection = item.dataset.section;
        this.render();
      };
    });
    
    // Search
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.oninput = (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.contact-row').forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      };
    }
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SCREENS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  showConnectScreen() {
    document.getElementById('app').innerHTML = `
      <div class="connect-screen">
        <div class="connect-card">
          <div style="font-size:60px;margin-bottom:20px;">üéØ</div>
          <h1 style="font-size:28px;margin-bottom:10px;background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;">CardGift CRM</h1>
          <p style="color:var(--text-muted);margin-bottom:30px;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
          <a href="dashboard.html" class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;text-decoration:none;justify-content:center;">üîó –ü–µ—Ä–µ–π—Ç–∏ –≤ –ü–∞–Ω–µ–ª—å</a>
        </div>
      </div>
    `;
  },
  
  showLoading() {
    document.getElementById('app').innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ CRM...</div>
      </div>
    `;
  },
  
  showError(message) {
    document.getElementById('app').innerHTML = `
      <div class="connect-screen">
        <div class="connect-card">
          <div style="font-size:60px;margin-bottom:20px;">‚ùå</div>
          <h2 style="margin-bottom:15px;">${message}</h2>
          <button class="btn btn-primary" onclick="location.reload()">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>
      </div>
    `;
  }
};

// Start
document.addEventListener('DOMContentLoaded', () => CRMApp.init());
</script>

</body>
</html>
