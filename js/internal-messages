// =============================================
// INTERNAL MESSAGES MODULE - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
// =============================================

let unreadCounts = {};
let currentMessages = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Å–æ–æ–±—â–µ–Ω–∏–π
async function initInternalMessages() {
    console.log('üì¨ Initializing Internal Messages...');
    await loadUnreadCounts();
    updateMessengerBadges();
    initNewsReadTracking();
}

// =============================================
// –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø
// =============================================

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞–º
async function loadUnreadCounts() {
    const gwId = window.userGwId || window.displayId;
    if (!gwId) return;
    
    try {
        // –ü–æ–ø—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
        const { data, error } = await supabase.rpc('get_unread_counts', { p_gw_id: gwId });
        
        if (data) {
            unreadCounts = data;
        } else {
            // Fallback - –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å
            const { data: messages } = await supabase
                .from('internal_messages')
                .select('from_messenger')
                .eq('to_gw_id', gwId)
                .eq('is_read', false);
            
            if (messages) {
                unreadCounts = {
                    telegram: messages.filter(m => m.from_messenger === 'telegram').length,
                    whatsapp: messages.filter(m => m.from_messenger === 'whatsapp').length,
                    viber: messages.filter(m => m.from_messenger === 'viber').length,
                    email: messages.filter(m => m.from_messenger === 'email').length,
                    phone: messages.filter(m => m.from_messenger === 'phone').length,
                    instagram: messages.filter(m => m.from_messenger === 'instagram').length,
                    facebook: messages.filter(m => m.from_messenger === 'facebook').length,
                    tiktok: messages.filter(m => m.from_messenger === 'tiktok').length,
                    twitter: messages.filter(m => m.from_messenger === 'twitter').length,
                    sponsor: messages.filter(m => m.from_messenger === 'sponsor').length,
                    total: messages.length
                };
            }
        }
        
        console.log('üì¨ Unread counts:', unreadCounts);
    } catch (e) {
        console.log('Messages table not ready:', e.message);
        unreadCounts = {};
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–≤
function updateMessengerBadges() {
    const messengerMap = {
        'telegram': 'Telegram',
        'whatsapp': 'WhatsApp', 
        'viber': 'Viber',
        'email': 'Email',
        'phone': '–¢–µ–ª–µ—Ñ–æ–Ω',
        'instagram': 'Instagram',
        'facebook': 'Facebook',
        'tiktok': 'TikTok',
        'twitter': 'Twitter/X'
    };
    
    Object.keys(messengerMap).forEach(key => {
        const count = unreadCounts[key] || 0;
        const cards = document.querySelectorAll(`[data-messenger="${key}"], [onclick*="'${key}'"]`);
        
        cards.forEach(card => {
            // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –±–µ–π–¥–∂
            const oldBadge = card.querySelector('.messenger-badge');
            if (oldBadge) oldBadge.remove();
            
            // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
            if (count > 0) {
                const badge = document.createElement('div');
                badge.className = 'messenger-badge';
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.cssText = `
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background: #ff4444;
                    color: white;
                    border-radius: 50%;
                    min-width: 20px;
                    height: 20px;
                    font-size: 11px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0 4px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    z-index: 10;
                `;
                
                // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ –∏–º–µ–µ—Ç position relative
                if (getComputedStyle(card).position === 'static') {
                    card.style.position = 'relative';
                }
                
                card.appendChild(badge);
            }
        });
    });
}

// =============================================
// –°–û–û–ë–©–ï–ù–ò–Ø –ü–û –ú–ï–°–°–ï–ù–î–ñ–ï–†–£
// =============================================

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—É
async function showMessengerMessages(messenger) {
    const gwId = window.userGwId || window.displayId;
    if (!gwId) return;
    
    try {
        const { data: messages, error } = await supabase
            .from('internal_messages')
            .select('*')
            .eq('to_gw_id', gwId)
            .eq('from_messenger', messenger)
            .order('created_at', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        currentMessages = messages || [];
        renderMessagesModal(messenger, currentMessages);
        
    } catch (e) {
        console.error('Error loading messages:', e);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π', 'error');
    }
}

// –†–µ–Ω–¥–µ—Ä –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
function renderMessagesModal(messenger, messages) {
    const messengerNames = {
        'telegram': 'üì± Telegram',
        'whatsapp': 'üí¨ WhatsApp',
        'viber': 'üíú Viber',
        'email': 'üìß Email',
        'phone': 'üìû –¢–µ–ª–µ—Ñ–æ–Ω',
        'instagram': 'üì∑ Instagram',
        'facebook': 'üë§ Facebook',
        'tiktok': 'üéµ TikTok',
        'twitter': 'üê¶ Twitter/X',
        'sponsor': 'üëë –°–ø–æ–Ω—Å–æ—Ä'
    };
    
    // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –º–æ–¥–∞–ª–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldModal = document.getElementById('messages-modal');
    if (oldModal) oldModal.remove();
    
    const unreadCount = messages.filter(m => !m.is_read).length;
    
    const modalHtml = `
        <div id="messages-modal" class="modal-overlay" style="display: flex !important;">
            <div class="modal-content" style="max-width: 500px; max-height: 80vh;">
                <div class="modal-header">
                    <h2>${messengerNames[messenger] || messenger} ${unreadCount > 0 ? `<span style="color: #ff4444; font-size: 14px;">(${unreadCount} –Ω–æ–≤—ã—Ö)</span>` : ''}</h2>
                    <button class="modal-close" onclick="closeMessagesModal()">‚úï</button>
                </div>
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 0;">
                    ${messages.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 50px; margin-bottom: 15px;">üì≠</div>
                            <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                        </div>
                    ` : messages.map(m => `
                        <div class="message-item ${m.is_read ? '' : 'unread'}" data-id="${m.id}" onclick="markMessageRead('${m.id}')" style="
                            padding: 15px;
                            border-bottom: 1px solid var(--border);
                            cursor: pointer;
                            background: ${m.is_read ? 'transparent' : 'rgba(255,215,0,0.05)'};
                            transition: background 0.2s;
                        ">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-weight: 600; color: ${m.is_read ? 'var(--text)' : 'var(--gold)'};">
                                    ${m.is_read ? '' : 'üîî '}${m.from_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}
                                </span>
                                <span style="font-size: 11px; color: var(--text-muted);">
                                    ${formatMessageTime(m.created_at)}
                                </span>
                            </div>
                            <div style="color: var(--text-muted); font-size: 14px; line-height: 1.4;">
                                ${escapeHtml(m.message)}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="modal-footer" style="display: flex; gap: 10px;">
                    ${unreadCount > 0 ? `
                        <button class="btn btn-yellow" onclick="markAllRead('${messenger}')">
                            ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
                        </button>
                    ` : ''}
                    <button class="btn btn-gray" onclick="closeMessagesModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
function closeMessagesModal() {
    const modal = document.getElementById('messages-modal');
    if (modal) modal.remove();
}

// –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
async function markMessageRead(messageId) {
    try {
        await supabase
            .from('internal_messages')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('id', messageId);
        
        // –û–±–Ω–æ–≤–∏—Ç—å UI
        const item = document.querySelector(`[data-id="${messageId}"]`);
        if (item) {
            item.classList.remove('unread');
            item.style.background = 'transparent';
            const name = item.querySelector('span');
            if (name) {
                name.style.color = 'var(--text)';
                name.textContent = name.textContent.replace('üîî ', '');
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏
        await loadUnreadCounts();
        updateMessengerBadges();
        
    } catch (e) {
        console.error('Error marking message read:', e);
    }
}

// –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –ø–æ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—É
async function markAllRead(messenger) {
    const gwId = window.userGwId || window.displayId;
    if (!gwId) return;
    
    try {
        await supabase
            .from('internal_messages')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('to_gw_id', gwId)
            .eq('from_messenger', messenger)
            .eq('is_read', false);
        
        showNotification('–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–º–µ—á–µ–Ω—ã –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏', 'success');
        closeMessagesModal();
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏
        await loadUnreadCounts();
        updateMessengerBadges();
        
    } catch (e) {
        console.error('Error marking all read:', e);
    }
}

// =============================================
// –ù–û–í–û–°–¢–ò - –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –ü–†–û–ß–¢–ï–ù–ò–Ø
// =============================================

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—á—Ç–µ–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π
function initNewsReadTracking() {
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π
    const originalShowNews = window.showNewsModal;
    if (originalShowNews) {
        window.showNewsModal = function() {
            originalShowNews.apply(this, arguments);
            // –û—Ç–º–µ—á–∞–µ–º –Ω–æ–≤–æ—Å—Ç–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(markNewsAsRead, 2000);
        };
    }
}

// –û—Ç–º–µ—Ç–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
async function markNewsAsRead() {
    const gwId = window.userGwId || window.displayId;
    if (!gwId) return;
    
    try {
        // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
        const { data: news } = await supabase
            .from('news')
            .select('id')
            .eq('is_active', true);
        
        if (!news || news.length === 0) return;
        
        // –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∂–¥—É—é –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—É—é
        for (const item of news) {
            await supabase
                .from('news_read_status')
                .upsert({
                    user_gw_id: gwId,
                    news_id: item.id,
                    read_at: new Date().toISOString()
                }, {
                    onConflict: 'user_gw_id,news_id'
                });
        }
        
        // –£–±—Ä–∞—Ç—å –±–µ–π–¥–∂ —Å –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
        updateNewsBadge(0);
        
        console.log('üì∞ News marked as read');
        
    } catch (e) {
        console.error('Error marking news as read:', e);
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
async function loadUnreadNewsCount() {
    const gwId = window.userGwId || window.displayId;
    if (!gwId) return 0;
    
    try {
        // –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        const { count: totalNews } = await supabase
            .from('news')
            .select('*', { count: 'exact', head: true })
            .eq('is_active', true);
        
        // –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        const { count: readNews } = await supabase
            .from('news_read_status')
            .select('*', { count: 'exact', head: true })
            .eq('user_gw_id', gwId);
        
        const unread = Math.max((totalNews || 0) - (readNews || 0), 0);
        updateNewsBadge(unread);
        return unread;
        
    } catch (e) {
        console.error('Error loading unread news:', e);
        return 0;
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å –±–µ–π–¥–∂ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–µ –Ω–æ–≤–æ—Å—Ç–µ–π
function updateNewsBadge(count) {
    const bell = document.querySelector('.notification-bell, #news-bell, [onclick*="showNewsModal"]');
    if (!bell) return;
    
    // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –±–µ–π–¥–∂
    const oldBadge = bell.querySelector('.news-badge');
    if (oldBadge) oldBadge.remove();
    
    if (count > 0) {
        const badge = document.createElement('span');
        badge.className = 'news-badge';
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.cssText = `
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 3px;
        `;
        
        if (getComputedStyle(bell).position === 'static') {
            bell.style.position = 'relative';
        }
        
        bell.appendChild(badge);
    }
}

// =============================================
// –ß–ê–¢ –°–ü–û–ù–°–û–†-–†–ï–§–ï–†–ê–õ
// =============================================

// –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç —Å–æ —Å–ø–æ–Ω—Å–æ—Ä–æ–º
async function showSponsorChat() {
    const gwId = window.userGwId || window.displayId;
    if (!gwId) return;
    
    try {
        // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–æ–Ω—Å–æ—Ä–∞
        const { data: user } = await supabase
            .from('users')
            .select('referrer_gw_id')
            .eq('gw_id', gwId)
            .single();
        
        if (!user?.referrer_gw_id) {
            showNotification('–£ –≤–∞—Å –Ω–µ—Ç —Å–ø–æ–Ω—Å–æ—Ä–∞', 'info');
            return;
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
        const { data: messages } = await supabase
            .from('internal_messages')
            .select('*')
            .or(`and(from_gw_id.eq.${gwId},to_gw_id.eq.${user.referrer_gw_id}),and(from_gw_id.eq.${user.referrer_gw_id},to_gw_id.eq.${gwId})`)
            .order('created_at', { ascending: true });
        
        renderSponsorChatModal(user.referrer_gw_id, messages || []);
        
    } catch (e) {
        console.error('Error loading sponsor chat:', e);
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º
async function showReferralChat(referralGwId) {
    const gwId = window.userGwId || window.displayId;
    if (!gwId) return;
    
    try {
        const { data: messages } = await supabase
            .from('internal_messages')
            .select('*')
            .or(`and(from_gw_id.eq.${gwId},to_gw_id.eq.${referralGwId}),and(from_gw_id.eq.${referralGwId},to_gw_id.eq.${gwId})`)
            .order('created_at', { ascending: true });
        
        renderSponsorChatModal(referralGwId, messages || [], true);
        
    } catch (e) {
        console.error('Error loading referral chat:', e);
    }
}

// –†–µ–Ω–¥–µ—Ä —á–∞—Ç–∞
function renderSponsorChatModal(partnerId, messages, isReferral = false) {
    const gwId = window.userGwId || window.displayId;
    
    // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é –º–æ–¥–∞–ª–∫—É
    const oldModal = document.getElementById('chat-modal');
    if (oldModal) oldModal.remove();
    
    const modalHtml = `
        <div id="chat-modal" class="modal-overlay" style="display: flex !important;">
            <div class="modal-content" style="max-width: 500px; max-height: 80vh; display: flex; flex-direction: column;">
                <div class="modal-header">
                    <h2>${isReferral ? 'üë§ –ß–∞—Ç —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º' : 'üëë –ß–∞—Ç —Å–æ —Å–ø–æ–Ω—Å–æ—Ä–æ–º'} ${partnerId}</h2>
                    <button class="modal-close" onclick="closeChatModal()">‚úï</button>
                </div>
                <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px; min-height: 300px;">
                    ${messages.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 40px; margin-bottom: 10px;">üí¨</div>
                            <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!</p>
                        </div>
                    ` : messages.map(m => `
                        <div style="
                            margin-bottom: 10px;
                            display: flex;
                            justify-content: ${m.from_gw_id === gwId ? 'flex-end' : 'flex-start'};
                        ">
                            <div style="
                                max-width: 80%;
                                padding: 10px 15px;
                                border-radius: 15px;
                                background: ${m.from_gw_id === gwId ? 'var(--gold)' : 'var(--bg-card)'};
                                color: ${m.from_gw_id === gwId ? '#000' : 'var(--text)'};
                            ">
                                <div style="font-size: 13px;">${escapeHtml(m.message)}</div>
                                <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; text-align: right;">
                                    ${formatMessageTime(m.created_at)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px;">
                    <input type="text" id="chat-input" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex: 1;" onkeypress="if(event.key==='Enter')sendChatMessage('${partnerId}')">
                    <button class="btn btn-yellow" onclick="sendChatMessage('${partnerId}')">üì§</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// –ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç
function closeChatModal() {
    const modal = document.getElementById('chat-modal');
    if (modal) modal.remove();
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
async function sendChatMessage(toGwId) {
    const gwId = window.userGwId || window.displayId;
    const input = document.getElementById('chat-input');
    const message = input?.value?.trim();
    
    if (!message || !gwId) return;
    
    try {
        await supabase
            .from('internal_messages')
            .insert({
                from_gw_id: gwId,
                to_gw_id: toGwId,
                from_name: gwId,
                from_messenger: 'sponsor',
                message: message,
                chat_id: `sponsor_${[gwId, toGwId].sort().join('_')}`
            });
        
        input.value = '';
        
        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            // –£–±—Ä–∞—Ç—å placeholder –µ—Å–ª–∏ –µ—Å—Ç—å
            const placeholder = chatMessages.querySelector('[style*="text-align: center"]');
            if (placeholder) placeholder.remove();
            
            chatMessages.insertAdjacentHTML('beforeend', `
                <div style="margin-bottom: 10px; display: flex; justify-content: flex-end;">
                    <div style="max-width: 80%; padding: 10px 15px; border-radius: 15px; background: var(--gold); color: #000;">
                        <div style="font-size: 13px;">${escapeHtml(message)}</div>
                        <div style="font-size: 10px; opacity: 0.7; margin-top: 5px; text-align: right;">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                    </div>
                </div>
            `);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
    } catch (e) {
        console.error('Error sending message:', e);
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
    }
}

// =============================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// =============================================

function formatMessageTime(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
    if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)} —á –Ω–∞–∑–∞–¥`;
    if (diff < 604800000) return `${Math.floor(diff / 86400000)} –¥–Ω –Ω–∞–∑–∞–¥`;
    
    return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =============================================
// –≠–ö–°–ü–û–†–¢ –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// =============================================

// –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initInternalMessages, 1000);
    setTimeout(loadUnreadNewsCount, 1500);
});

// –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(async () => {
    await loadUnreadCounts();
    updateMessengerBadges();
}, 30000);

console.log('‚úÖ Internal Messages module loaded');
